<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>MySQL8新特性公用表表达式MySQL笔记 • stardust's blog</title><meta name="description" content="MySQL8新特性公用表表达式MySQL笔记 - stardust"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="https://unpkg.com/nanoreset@3.0.1/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="stardust's blog"><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="stardust's blog" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="stardust's blog"><img class="logo-image" src="/logo.svg" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/about" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">MySQL8新特性公用表表达式MySQL笔记</h1><div class="post-info"><a></a>2022-05-04</div><div class="post-content"><p>公用表表达式，简称CTE(Common Table Expression)</p>
<p>CTE是一个命名的临时结果集，类似于可以复用的子查询</p>
<h1 id="普通公用表表达式"><a href="#普通公用表表达式" class="headerlink" title="普通公用表表达式"></a>普通公用表表达式</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#查询员工所在部门的详细信息</span><br><span class="line"><span class="keyword">WITH</span> cte_emp</span><br><span class="line"><span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> department_id</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> departments d <span class="keyword">join</span> cte_emp</span><br><span class="line"><span class="keyword">where</span> d.department_id <span class="operator">=</span> cte_emp.department_id;</span><br></pre></td></tr></table></figure>

<h1 id="递归公用表表达式"><a href="#递归公用表表达式" class="headerlink" title="递归公用表表达式"></a>递归公用表表达式</h1><p>可以自己调用自己</p>
<p>递归公用表表达式由 2 部分组成，分别是种子查询和递归查询，中间通过关键字 UNION [ALL]进行连接。 这里的种子查询，意思就是获得递归的初始值。这个查询只会运行一次，以创建初始数据集，之后递归 查询会一直执行，直到没有任何新的查询数据产生，递归返回。</p>
<p>案例：针对于我们常用的employees表，包含employee_id，last_name和manager_id三个字段。如果a是b 的管理者，那么，我们可以把b叫做a的下属，如果同时b又是c的管理者，那么c就是b的下属，是a的下下 属。 </p>
<p>下面我们尝试用查询语句列出所有具有下下属身份的人员信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> cte</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,manager_id,<span class="number">1</span> <span class="keyword">AS</span> n <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">100</span></span><br><span class="line"><span class="comment">-- 种子查询，找到第一代领导</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> a.employee_id,a.last_name,a.manager_id,n<span class="operator">+</span><span class="number">1</span> <span class="keyword">FROM</span> employees <span class="keyword">AS</span> a <span class="keyword">JOIN</span> cte</span><br><span class="line"><span class="keyword">ON</span> (a.manager_id <span class="operator">=</span> cte.employee_id) <span class="comment">-- 递归查询，找出以递归公用表表达式的人为领导的人</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name <span class="keyword">FROM</span> cte <span class="keyword">WHERE</span> n <span class="operator">&gt;=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>递归公用表表达式适用于查询一个有共同的根节点的树形结构数据</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/05/08/0c1810806d61/">prev</a><a class="next" href="/2022/05/04/cb5279dca9ea/">next</a></div><div class="copyright"><p>&copy; 2022 <a href="https://stardust-sudo.github.io">stardust</a><br>Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a></p></div></footer></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>