<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>子查询 尚硅谷MySQL入门到高级-宋红康版笔记 • stardust's blog</title><meta name="description" content="子查询 尚硅谷MySQL入门到高级-宋红康版笔记 - stardust"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="https://unpkg.com/nanoreset@3.0.1/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="stardust's blog"><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="stardust's blog" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="stardust's blog"><img class="logo-image" src="/logo.svg" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/about" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">子查询 尚硅谷MySQL入门到高级-宋红康版笔记</h1><div class="post-info"><a></a>2022-04-28</div><div class="post-content"><h1 id="子查询概述"><a href="#子查询概述" class="headerlink" title="子查询概述"></a>子查询概述</h1><h2 id="子查询的基本使用"><a href="#子查询的基本使用" class="headerlink" title="子查询的基本使用"></a>子查询的基本使用</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查询比Abel工资高的员工</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (</span><br><span class="line">                <span class="keyword">SELECT</span> salary</span><br><span class="line">                <span class="keyword">FROM</span> employees</span><br><span class="line">                <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span></span><br><span class="line">                );</span><br></pre></td></tr></table></figure>

<ul>
<li><p>称谓：外查询（主查询）和内查询（子查询）</p>
</li>
<li><p>子查询在主查询之前一次执行完成</p>
</li>
<li><p>子查询结果被主查询使用</p>
</li>
<li><p>子查询要被包含在括号内</p>
</li>
<li><p>将子查询放在比较条件右侧</p>
</li>
<li><p>单行操作符对应单行子查询，多行操作符对应多行子查询</p>
</li>
</ul>
<h2 id="子查询分类"><a href="#子查询分类" class="headerlink" title="子查询分类"></a>子查询分类</h2><ul>
<li>单行子查询&#x2F;多行子查询，单行子查询返回一行，多行子查询返回多行</li>
<li>相关子查询&#x2F;不相关子查询，分类取决于内查询和外查询是否相关</li>
</ul>
<h1 id="单行子查询"><a href="#单行子查询" class="headerlink" title="单行子查询"></a>单行子查询</h1><p>内查询返回单行数据</p>
<h2 id="单行比较操作符"><a href="#单行比较操作符" class="headerlink" title="单行比较操作符"></a>单行比较操作符</h2><p>&#x3D; &gt; &gt;&#x3D; &lt; &lt;&#x3D; !&#x3D;</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,manager_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> (manager_id,department_id) <span class="operator">=</span> (<span class="keyword">SELECT</span> manager_id,department_id</span><br><span class="line">                                    <span class="keyword">FROM</span> employees</span><br><span class="line">                                    <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">141</span>)</span><br><span class="line"><span class="keyword">AND</span> employee_id <span class="operator">!=</span> <span class="number">141</span>;</span><br></pre></td></tr></table></figure>

<h2 id="HAVING中的子查询"><a href="#HAVING中的子查询" class="headerlink" title="HAVING中的子查询"></a>HAVING中的子查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> department_id,<span class="built_in">MIN</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MIN</span>(salary) <span class="operator">&gt;</span> (</span><br><span class="line">                      <span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary)</span><br><span class="line">                      <span class="keyword">FROM</span> employees</span><br><span class="line">                      <span class="keyword">where</span> department_id <span class="operator">=</span> <span class="number">50</span></span><br><span class="line">                      );</span><br></pre></td></tr></table></figure>

<h1 id="多行子查询"><a href="#多行子查询" class="headerlink" title="多行子查询"></a>多行子查询</h1><p>内查询返回多行数据</p>
<h2 id="多行比较操作符"><a href="#多行比较操作符" class="headerlink" title="多行比较操作符"></a>多行比较操作符</h2><p>IN 等于列表中的任意一个</p>
<p>ANY 需要和单行比较操作符一起使用，和子查询返回的某一个值比较</p>
<p>ALL 需要和单行比较操作符一起使用，和子查询返回的所有值比较</p>
<p>SOME 实际上是ANY的别名，作用相同，一般使用ANY</p>
<h2 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="keyword">IN</span> (</span><br><span class="line">                 <span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary)</span><br><span class="line">                 <span class="keyword">FROM</span> employees</span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line">                 );</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&lt;</span> <span class="keyword">ANY</span>(<span class="keyword">SELECT</span> salary</span><br><span class="line">                   <span class="keyword">FROM</span> employees</span><br><span class="line">                   <span class="keyword">where</span> job_id <span class="operator">=</span> <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line">                   )</span><br><span class="line"><span class="keyword">AND</span> job_id <span class="operator">!=</span> <span class="string">&#x27;IT_PROG&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&lt;</span> <span class="keyword">ALL</span>(<span class="keyword">SELECT</span> salary</span><br><span class="line">                   <span class="keyword">FROM</span> employees</span><br><span class="line">                   <span class="keyword">where</span> job_id <span class="operator">=</span> <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line">                   )</span><br><span class="line"><span class="keyword">AND</span> job_id <span class="operator">!=</span> <span class="string">&#x27;IT_PROG&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="相关子查询"><a href="#相关子查询" class="headerlink" title="相关子查询"></a>相关子查询</h1><h2 id="相关子查询执行流程"><a href="#相关子查询执行流程" class="headerlink" title="相关子查询执行流程"></a>相关子查询执行流程</h2><ol>
<li>从主查询获取候选列</li>
<li>使用主查询的数据进行查询</li>
<li>如果满足子查询的条件则返回该行数据</li>
</ol>
<h2 id="代码示例-2"><a href="#代码示例-2" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#查询员工中工资大于本部门平均工资的员工的last_name,salary和department_id</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (</span><br><span class="line">                <span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary)</span><br><span class="line">                <span class="keyword">FROM</span> employees e2</span><br><span class="line">                <span class="keyword">WHERE</span> e2.`department_id` <span class="operator">=</span> e1.`department_id`</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> emp.last_name,emp.salary,emp.department_id</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">      <span class="keyword">SELECT</span> department_id,<span class="built_in">AVG</span>(salary) avg_sal</span><br><span class="line">      <span class="keyword">FROM</span> employees</span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line">      ) t_dept_avg_sal</span><br><span class="line"><span class="keyword">JOIN</span> employees emp</span><br><span class="line"><span class="keyword">ON</span> t_dept_avg_sal.department_id <span class="operator">=</span> emp.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> emp.`salary`<span class="operator">&gt;</span>t_dept_avg_sal.avg_sal;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#查询员工的id,salary,按照department_name排序</span><br><span class="line"><span class="keyword">select</span> emp.employee_id,emp.salary,dept.`department_name`</span><br><span class="line"><span class="keyword">from</span> employees emp <span class="keyword">join</span> departments dept</span><br><span class="line"><span class="keyword">on</span> emp.`department_id`<span class="operator">=</span>dept.`department_id`</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> dept.`department_name`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> emp.employee_id,emp.salary</span><br><span class="line"><span class="keyword">FROM</span> employees emp </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (</span><br><span class="line">          <span class="keyword">select</span> department_name</span><br><span class="line">          <span class="keyword">from</span> departments dept</span><br><span class="line">          <span class="keyword">where</span> dept.`department_id`<span class="operator">=</span>emp.`department_id`</span><br><span class="line">          );</span><br></pre></td></tr></table></figure>

<p>在SELECT中，除了GROUP BY和LIMIT之外，其他位置都可以声明子查询</p>
<h2 id="EXISTS与NOT-EXISTS关键字"><a href="#EXISTS与NOT-EXISTS关键字" class="headerlink" title="EXISTS与NOT EXISTS关键字"></a>EXISTS与NOT EXISTS关键字</h2><p>EXISTS用来检查子查询中是否存在满足条件的行</p>
<ul>
<li>如果在子查询中不存在满足条件的行，条件返回FALSE，继续在子查询中查找</li>
<li>如果在子查询中存在满足条件的行，不继续在子查询中查找，条件返回TRUE</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查询公司管理者的employee_id,last_name,job_id,department_id信息</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees mgr</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">             <span class="keyword">FROM</span> employees emp</span><br><span class="line">             <span class="keyword">WHERE</span> emp.`manager_id`<span class="operator">=</span>mgr.`employee_id`</span><br><span class="line">             );</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查询departments表中，不存在于employees表中的部门的department_id和department_name</span><br><span class="line"><span class="keyword">Select</span> department_id,department_name</span><br><span class="line"><span class="keyword">from</span> departments dept</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">	       <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">	       <span class="keyword">from</span> employees emp</span><br><span class="line">	       <span class="keyword">where</span> emp.`department_id`<span class="operator">=</span>dept.`department_id`</span><br><span class="line">	       );</span><br></pre></td></tr></table></figure>

<p>多表连接比子查询效率高</p>
<p>另：表.* 表示表的所有字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#查询平均工资最高的job信息</span><br><span class="line"><span class="keyword">select</span> jobs.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> jobs</span><br><span class="line"><span class="keyword">where</span> job_id <span class="operator">=</span> (</span><br><span class="line">                <span class="keyword">SELECT</span> job_id</span><br><span class="line">                <span class="keyword">FROM</span> employees</span><br><span class="line">                <span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">AVG</span>(salary) <span class="keyword">DESC</span></span><br><span class="line">                LIMIT <span class="number">1</span></span><br><span class="line">                );</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a class="next" href="/2022/04/28/947e8a4d2c73/">next</a></div><div class="copyright"><p>&copy; 2022 <a href="https://stardust-sudo.github.io">stardust</a><br>Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a></p></div></footer></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>